<template>
<div class="admin-dashboard-wrapper">
    <b-loading :is-full-page="false" :active="loading"></b-loading>
    <template v-if="!loading">
        <h2>{{$t("currently")}}</h2>
        <div class="level">
            <div class="level-item has-text-centered">
                <div>
                <p class="heading">{{$t("online-users")}}</p>
                <p class="title">{{currentStats.users}}</p>
                </div>
            </div>
            <div class="level-item has-text-centered">
                <div>
                <p class="heading">{{$t("active-projects")}}</p>
                <p class="title">{{currentStats.projects}}</p>
                </div>
            </div>
            <div class="level-item has-text-centered">
                <div>
                <p class="heading">{{$t("used-storage-space")}}</p>
                <p class="title">{{Math.round(storageStats.usedP * 100)}}%</p>
                </div>
            </div>
        </div>

        <p v-if="currentStats.mostActiveProject">
            <strong>{{$t("most-active-project")}}</strong>:
            <router-link :to="`/project/${currentStats.mostActiveProject.project.id}`">
                {{currentStats.mostActiveProject.project.name}}
            </router-link>
            ({{$tc("count-active-users", currentStats.mostActiveProject.users, {count: currentStats.mostActiveProject.project})}})
        </p>

        <hr>

        <h2>{{$t("total")}}</h2>
        <div class="columns">
            <div class="column">
                <table class="table is-fullwidth">
                    <tbody>
                        <tr>
                            <td>{{totalCounts.users}}</td>
                            <td>{{$t("users")}}</td>
                        </tr>
                        <tr>
                            <td>{{totalCounts.projects}}</td>
                            <td>{{$t("projects")}}</td>
                        </tr>
                        <tr>
                            <td>{{totalCounts.images}}</td>
                            <td>{{$t("images")}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="column">
                <table class="table is-fullwidth">
                    <tbody>
                        <tr>
                            <td>{{totalCounts.ontologies}}</td>
                            <td>{{$t("ontologies")}}</td>
                        </tr>
                        <tr>
                            <td>{{totalCounts.terms}}</td>
                            <td>{{$t("terms")}}</td>
                        </tr>
                        <tr>
                            <td>{{totalCounts.userAnnotations}}</td>
                            <td>{{$t("user-annotations")}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="column">
                <table class="table is-fullwidth">
                    <tbody>
                        <tr>
                            <td>{{totalCounts.softwares}}</td>
                            <td>{{$t("algorithms")}}</td>
                        </tr>
                        <tr>
                            <td>{{totalCounts.jobs}}</td>
                            <td>{{$t("analyses")}}</td>
                        </tr>
                        <tr>
                            <td>{{totalCounts.jobAnnotations}}</td>
                            <td>{{$t("analysis-annotations")}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <hr>
        <h2>{{$t("last-connections")}}</h2>

        <div class="is-flex">
            <strong class="has-margin-right">{{$t("period")}}</strong>
            <b-select v-model="selectedChartOption">
                <option v-for="option in chartOptions" :key="option.label" :value="option">
                    {{option.label}}
                </option>
            </b-select>
        </div>

        <div class="chart-container">
            <last-connections-chart css-classes="chart"
                :startDate="selectedChartOption.startDate"
                :period="selectedChartOption.period">
            </last-connections-chart>
        </div>

    </template>
</div>
</template>

<script>
import {Cytomine} from "cytomine-client";
import LastConnectionsChart from "@/components/charts/LastConnectionsChart.js";
import moment from "moment";

export default {
    name: "admin-dashboard",
    components: {LastConnectionsChart},
    data() {
        return {
            loading: true,
            currentStats: {},
            totalCounts: {},
            storageStats: {},
            chartOptions: [],
            selectedChartOption: null
        };
    },
    methods: {
        async fetchCurrentStats() {
            this.currentStats = await Cytomine.instance.fetchCurrentStats();
        },
        async fetchTotalCounts() {
            this.totalCounts = await Cytomine.instance.fetchTotalCounts();
        },
        async fetchStorageStats() {
            this.storageStats = await Cytomine.instance.fetchStorageStats();
        }
    },
    async created() {
        let chartOptions = [
            {interval: "day", period: "hour"},
            {interval: "week", period: "day"},
            {interval: "year", period: "week"}
        ];
        this.chartOptions = chartOptions.map(option => {
            let startDate = moment()
                .add(1, option.period + "s")
                .subtract(1, option.interval + "s")
                .startOf(option.period)
                .valueOf();
            return {label: this.$t(`last-${option.interval}`), period: option.period, startDate};
        });
        this.selectedChartOption = this.chartOptions[0];

        try {
            await Promise.all([
                this.fetchCurrentStats(),
                this.fetchTotalCounts(),
                this.fetchStorageStats()
            ]);
        }
        catch(error) {
            console.log(error);
            this.error = true;
        }
        this.loading = false;
    }
};
</script>

<style scoped>
.admin-dashboard-wrapper {
    position: relative;
    min-height: 10em;
}

td:first-child {
    font-weight: 600;
    text-align: right;
    padding-right: 1em;
}

.is-flex {
    align-items: center;
}

.has-margin-right {
    margin-right: 1em;
}

.chart-container {
    margin-top: 2em;
    height: 20em;
    position: relative;
}
</style>

<style>
.admin-dashboard-wrapper .chart {
    position: absolute;
    height: 100%;
    width: 100%;
}
</style>

