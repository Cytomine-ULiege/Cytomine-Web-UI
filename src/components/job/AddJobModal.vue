<template>
<b-modal :active="active" @close="$emit('update:active', false)" :has-modal-card="true" class="add-job-modal">
  <form @submit.prevent="createJob()">
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">{{$t('launch-new-analysis')}}</p>
      </header>
      <section class="modal-card-body">
        <div class="columns">
          <div class="column is-narrow">
            <strong>{{$t('algorithm')}}</strong>
          </div>
          <div class="column">
            <cytomine-multiselect v-model="selectedSoftware" :options="softwares" track-by="id" label="name" />
          </div>
        </div>
        <template v-if="selectedSoftware">
          <table class="table is-fullwidth">
            <thead>
              <tr>
                <th>{{$t('name')}}</th>
                <th>{{$t('value')}}</th>
              </tr>
            </thead>
            <tbody>
              <job-parameter-row
                v-for="param in paramsMandatoryNoDefault"
                :param="param"
                :key="param.id"
                v-model="param.value"
              />

              <tr class="row-separator" v-if="optionalParams.length > 0">
                <td colspan="2">
                  {{$t('optional-parameters')}}
                  <button class="button is-small" type="button" @click="showOptional = !showOptional">
                    {{$t(showOptional ? 'button-hide' : 'button-show')}}
                  </button>
                </td>
              </tr>
              <template v-if="showOptional">
                <job-parameter-row
                  v-for="param in optionalParams"
                  :param="param"
                  :key="param.id"
                  v-model="param.value"
                />
              </template>

              <tr class="row-separator" v-if="prefilledParams.length > 0">
                <td colspan="2">
                  {{$t('prefilled-parameters')}}
                  <button class="button is-small" type="button" @click="showPrefilled = !showPrefilled">
                    {{$t(showPrefilled ? 'button-hide' : 'button-show')}}
                  </button>
                </td>
              </tr>
              <template v-if="showPrefilled">
                <job-parameter-row
                  v-for="param in prefilledParams"
                  :param="param"
                  :key="param.id"
                  v-model="param.value"
                />
              </template>
            </tbody>
          </table>
        </template>
      </section>
      <footer class="modal-card-foot">
        <button class="button" type="button" @click="$emit('update:active', false)">
          {{$t('button-cancel')}}
        </button>
        <button class="button is-link" :disabled="errors.any()">
          {{$t('button-launch-new-analysis')}}
        </button>
      </footer>
    </div>
  </form>
</b-modal>
</template>

<script>
import {get} from '@/utils/store-helpers';

import {SoftwareCollection, Job, JobParameter} from 'cytomine-client';
import CytomineMultiselect from '@/components/form/CytomineMultiselect';
import JobParameterRow from './JobParameterRow';

export default {
  name: 'add-job-modal',
  $_veeValidate: {validator: 'new'},
  components: {
    CytomineMultiselect,
    JobParameterRow
  },
  props: {
    active: Boolean
  },
  data() {
    return {
      softwares: [],
      selectedSoftware: null,
      showPrefilled: false,
      showOptional: false
    };
  },
  computed: {
    project: get('currentProject/project'),
    params() {
      return this.selectedSoftware ? this.selectedSoftware.parameters.array : [];
    },
    optionalParams() {
      return this.params.filter(param => !param.required && !param.defaultParamValue);
    },
    prefilledParams() {
      return this.params.filter(param => param.defaultParamValue);
    },
    paramsMandatoryNoDefault() {
      return this.params.filter(param => param.required && !param.defaultParamValue);
    },
    jobParameters() {
      return this.params.map(param => {
        let value = param.value;
        if(value.id) {
          value = value.id;
        }
        if(Array.isArray(value) && value.length > 0 && value[0].id) {
          value = value.map(model => model.id);
        }
        return new JobParameter({softwareParameter: param.id, value});
      });
    }
  },
  watch: {
    active(val) {
      if(val) {
        this.selectedSoftware = null;
        this.showOptional = false;
        this.showPrefilled = false;
      }
    },
    async selectedSoftware() {
      if(!this.selectedSoftware) {
        return;
      }
      for(let param of this.selectedSoftware.parameters) {
        this.$set(param, 'value', param.defaultParamValue);
      }
    }
  },
  methods: {
    async createJob() {
      let result = await this.$validator.validateAll();
      if(!result) {
        return;
      }

      try {
        let job = new Job({
          software: this.selectedSoftware.id,
          project: this.project.id,
          jobParameters: this.jobParameters
        });
        await job.save();
        this.$emit('add', job);
        this.$emit('update:active', false);
        await job.execute();
        this.$notify({type: 'success', text: this.$t('notif-success-analysis-launch')});
      }
      catch(error) {
        console.log(error);
        this.$notify({type: 'error', text: this.$t('notif-error-analysis-launch')});
      }
    }
  },
  async created() {
    this.softwares = (await SoftwareCollection.fetchAll({filterKey: 'project', filterValue: this.project.id})).array;
  }
};
</script>

<style scoped>
.modal-card {
  width: 100%;
  min-height: 70vh;
}

.columns {
  align-items: center;
}

.table {
  margin-bottom: 1em;
}

th:first-child {
  width: 20%;
}

td {
  vertical-align: middle !important;
}

.row-separator td {
  border-top-width: 2px !important;
  border-bottom-width: 1px !important;
  font-weight: 600;
}
</style>

<style>
.add-job-modal .animation-content {
  min-width: 70vw;
  min-height: 70vh;
}
</style>
