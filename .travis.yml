sudo: required
services:
- docker
language: node_js
node_js:
- 12
env:
  global:
  - DOCKER_USERNAME=cytomineulg
  -  secure: "0s8uZpK0C07Zn111O+Cdora5NksV+jbnhESAXZ46QZHh3z84taWjUlppYfBUgk43N+fzfwSC1EeaWm4CeuNMKP+FgNdfguMLVONLtvPCx19a98l10pAUfTIlBW89QrVNVu4BmCagTMhPTxDBGFwzkRxcx5V8tOAUSdau56XhmSfkNa/dfT1UBJJtDIuylokOpNsM3RrVkpRDvrwiObAWgYGuuo4vhWj9qChaO4kx4iTXDc8oANaXun6pdkZ0zd3L9wj1USWOEJg834JPiH0ZotG82nSBV37OHwE0nIQXBouyEhhYQOe5vQOkzd6quhYMA6X9MiXg36+DndBq9o/3vIZisct6Br+waCg8fVtJBaZr7uw0y20hYsFKi66JNTDPIqgMLbZb8pgsvcma/hDyrn2T/P0ymGIldvv3BZ14gMAL7T3ILwDSqMR2TFNFs+YnsWA7V1ApfsLtoI+WNljU46APKjdd2AztYIGgfZj30xb3Z6hqW8rqzz2zxSV+iXSOw+rWZV7hjB6Cux+3mRFgeCoIn/Lie5KN856pAJAF0Cs4p4MtgyZOIXahcy+V09704qXi49fqjYM9cJ4OAXuW4LTtpgEHIPl6tIvBsRadnNRLApaGt5fj7dMFrbomIjn5TR8lOfahlBV4T7JR3IrELzJsdyK3UhaSqj2MCgR4iHw="
script:
- echo "Skip tests"
after_success:
- npm pack
- git fetch --tags
- |
  export VERSION=$(sed -nE 's/^\s*"version": "(.*?)",$/\1/p' package.json);
  export DEPLOY=false;
  if [[ ! $(git tag -l v$VERSION) ]]; then
    git config --local user.name "$(git log -1 --pretty=format:'%an')";
    git config --local user.email "$(git log -1 --pretty=format:'%ae')";
    git tag "v$VERSION";
    export DEPLOY=true;
    echo "Deploy with version $VERSION";
    docker build -f docker/Dockerfile -t cytomineuliege/web-ui:v$VERSION .;
  fi;
deploy:
  - provider: script
    script: >
      echo $VERSION &&
      docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" &&
      docker push cytomineuliege/web-ui:v$VERSION &&
      echo "Done."
    skip_cleanup: true
    on:
      condition: $DEPLOY = true
  - provider: releases
    edge: true
    api_key:
      secure: v6iaN/oL+rDe06b7LegdOJtvm/mcNLeh4i7S+UXtBauZWGt4lhR8FqLP3qKqRaHyS31cOi2rHtl60FZFfpyp88rmsDYdAgybL05b6WolBp/T+dW5rauADz2A0Yb3CurEOjWgrvCw2DIzg+SEOaNVAVq7ue6hXomfsEoyNHyTr/cChwgyXUmg2RAFV/w9ftucANofZUku7cxDmxpKdev38Y+9vN5D4cqdwoPRBxnXiU56lXa4xv4AHu/XdHCmcSDYpRlVTypPsI2LshPltmXatvhOhF0aGCWGfcSqZ4g0Wn3jfv2+rHSePn/tgJ23MHSN6uaEYjCK0bZB8q5FLqZ2BnaWwiFssYw4NWyszlyuvzJSo97PV9n8hUk6Q6i5XXYVcAskTP5E+9LdMf0gEpfXSjd0hFKggM9IQIxQYhCcnHTgrpSgezrqLZJDuRoknVKGcdTn58MwIqJ2TxlmfNYINxp1BlAsMqGBV5vHtAG1L1F+o4Sfw6EEQhZT37r+K6ye6kZ6iXNDw+ufPdKPmo9TdpL55klP0MWWJhqcBgy8y8ydkd9iZwfYvZbHyxk5PplgrYEJphJ6uksgwfcKTAb/eFEhATp7vs5NLpPMZhRuNmMUj+ucu+NrtfrLN5yM+XNsuRAXESCBHTf30PLOUvb9pMyZ+kvDPMY/pkxp2AY1qvU=
    file: "*.{tgz}"
    skip_cleanup: true
    on:
      condition: $DEPLOY = true
